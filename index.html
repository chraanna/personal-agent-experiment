<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#f8f6f2" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="apple-touch-icon" href="/icon-192.png" />
  <title>Shilpi</title>

  <style>
    *, *::before, *::after {
      box-sizing: border-box;
    }

    :root {
      --sand: #c8b898;
      --sand-light: #e8dfd1;
      --sand-bg: #f8f6f2;
      --ink: #2a2a2a;
      --ink-soft: #6b6560;
      --ink-muted: #a09890;
      --white: #ffffff;
    }

    body {
      margin: 0;
      background: var(--sand-bg);
      color: var(--ink);
      font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont,
        "Helvetica Neue", Helvetica, Arial, sans-serif;
      height: 100vh;
      height: 100dvh;
      display: flex;
      justify-content: center;
      -webkit-font-smoothing: antialiased;
    }

    .container {
      width: 100%;
      max-width: 480px;
      height: 100vh;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }

    /* ===== Onboarding ===== */

    #onboarding {
      border: none;
      padding: 0 24px;
      min-height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 8px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding-top: 24px;
      padding-bottom: 24px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 0 0 10px;
      opacity: 0;
      transform: translateY(8px);
      animation: fadeUp 0.5s ease forwards;
    }

    .logo-mark {
      width: 28px;
      height: 28px;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--sand) 0%, var(--sand-light) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(200, 184, 152, 0.3);
    }

    .logo-mark svg {
      width: 16px;
      height: 16px;
    }

    .logo-text {
      display: flex;
      flex-direction: column;
      line-height: 1;
    }

    .logo-name {
      font-size: 18px;
      font-weight: 400;
      letter-spacing: -0.02em;
      color: var(--ink-soft);
    }

    .logo-subtitle {
      font-size: 10px;
      font-weight: 300;
      letter-spacing: 0.32em;
      text-transform: uppercase;
      color: var(--ink-muted);
      margin-top: 2px;
    }

    .intro-greeting {
      font-size: 14px;
      font-weight: 400;
      color: var(--ink-soft);
      margin: 0 0 2px;
      padding: 0;
      opacity: 0;
      transform: translateY(8px);
      animation: fadeUp 0.5s ease forwards;
      animation-delay: 0.05s;
    }

    .intro-text {
      font-size: 13px;
      line-height: 1.5;
      color: var(--ink-soft);
      font-weight: 300;
      letter-spacing: 0.01em;
      margin: 0 0 4px;
      padding: 0;
      opacity: 0;
      transform: translateY(8px);
      animation: fadeUp 0.5s ease forwards;
      animation-delay: 0.1s;
    }

    .card {
      background: rgba(255, 255, 255, 0.35);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      border-radius: 12px;
      padding: 10px 14px;
      opacity: 0;
      transform: translateY(8px);
      animation: fadeUp 0.5s ease forwards;
    }

    .card:nth-of-type(1) { animation-delay: 0.2s; }
    .card:nth-of-type(2) { animation-delay: 0.35s; }
    .card:nth-of-type(3) { animation-delay: 0.5s; }
    .card:nth-of-type(4) { animation-delay: 0.65s; }

    @keyframes fadeUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card-label {
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--ink-muted);
      margin: 0 0 6px;
    }

    .muted {
      color: var(--ink-muted);
      font-size: 13px;
      margin: 0;
    }

    p {
      margin: 0 0 10px;
      font-size: 14px;
      line-height: 1.55;
      color: var(--ink);
      font-weight: 300;
    }

    input {
      width: 100%;
      font-size: 15px;
      font-weight: 300;
      padding: 4px 0;
      border: none;
      border-bottom: 1px solid var(--sand-light);
      outline: none;
      background: transparent;
      color: var(--ink);
      transition: border-color 0.3s ease;
      font-family: inherit;
    }

    input:focus {
      border-bottom-color: var(--sand);
    }

    input::placeholder {
      color: var(--ink-muted);
    }

    /* Personality pills */
    .choices {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .choice {
      padding: 5px 12px;
      font-size: 12px;
      font-weight: 400;
      letter-spacing: 0.02em;
      border: 1px solid rgba(255, 255, 255, 0.6);
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      color: var(--ink-soft);
      cursor: pointer;
      user-select: none;
      transition: all 0.25s ease;
    }

    .choice:hover {
      border-color: var(--sand);
      color: var(--ink);
      background: rgba(255, 255, 255, 0.5);
    }

    .choice.selected {
      background: var(--sand);
      border-color: var(--sand);
      color: var(--white);
    }

    /* Calendar links */
    .calendar-options {
      display: flex;
      gap: 16px;
    }

    .calendar-link {
      display: inline-block;
      font-size: 13px;
      font-weight: 400;
      color: var(--ink-soft);
      text-decoration: none;
      border-bottom: 1px solid var(--sand-light);
      transition: all 0.25s ease;
    }

    .calendar-link:hover {
      color: var(--ink);
      border-bottom-color: var(--sand);
    }

    /* CTA */
    .cta {
      margin-top: 4px;
      margin-bottom: 20px;
      display: flex;
      justify-content: center;
      opacity: 0;
      transform: translateY(8px);
      animation: fadeUp 0.5s ease forwards;
      animation-delay: 0.8s;
    }

    #startBtn {
      padding: 12px 44px;
      font-size: 14px;
      font-weight: 500;
      letter-spacing: 0.04em;
      background: var(--ink);
      color: var(--sand-bg);
      border: none;
      border-radius: 999px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    #startBtn:hover {
      background: var(--sand);
      color: var(--white);
    }

    /* ===== Chat header ===== */

    .chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 24px;
      border-bottom: 1px solid rgba(200, 184, 152, 0.15);
      flex-shrink: 0;
    }

    .chat-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chat-header .logo-mark {
      width: 24px;
      height: 24px;
      border-radius: 8px;
    }

    .chat-header .logo-mark svg {
      width: 13px;
      height: 13px;
    }

    .chat-header-name {
      font-size: 15px;
      font-weight: 400;
      color: var(--ink-soft);
      letter-spacing: -0.01em;
    }

    .chat-header-status {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 11px;
      color: var(--ink-muted);
    }

    .chat-header-status .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--sand-light);
      transition: background 0.3s ease;
    }

    .chat-header-status .status-dot.connected {
      background: #8fae83;
    }

    .menu-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border-radius: 8px;
      transition: background 0.2s ease;
    }

    .menu-btn:hover {
      background: rgba(200, 184, 152, 0.15);
    }

    .menu-btn svg {
      width: 18px;
      height: 18px;
      stroke: var(--ink-muted);
      stroke-width: 1.5;
      fill: none;
    }

    /* ===== Chat messages area ===== */

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px 24px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      -webkit-overflow-scrolling: touch;
    }

    .chat-messages-spacer {
      flex: 1;
    }

    .msg {
      max-width: 85%;
      padding: 10px 14px;
      border-radius: 16px;
      font-size: 14px;
      font-weight: 300;
      line-height: 1.5;
      white-space: pre-wrap;
      animation: fadeUp 0.25s ease forwards;
    }

    .msg-user {
      align-self: flex-end;
      background: var(--ink);
      color: var(--sand-bg);
      border-bottom-right-radius: 4px;
    }

    .msg-agent {
      align-self: flex-start;
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      color: var(--ink-soft);
      border-bottom-left-radius: 4px;
    }

    .msg-event {
      align-self: flex-start;
      background: rgba(200, 184, 152, 0.15);
      color: var(--ink-soft);
      font-size: 13px;
      border-radius: 12px;
    }

    .msg-typing {
      align-self: flex-start;
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      color: var(--ink-muted);
      border-bottom-left-radius: 4px;
    }

    .typing-dots span {
      animation: pulse 1.4s infinite both;
    }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes pulse {
      0%, 80%, 100% { opacity: 0.2; }
      40% { opacity: 1; }
    }

    /* ===== Chat input bar ===== */

    .chat-input-bar {
      flex-shrink: 0;
      padding: 8px 24px;
      padding-bottom: max(8px, env(safe-area-inset-bottom));
      border-top: 1px solid rgba(200, 184, 152, 0.15);
    }

    .chat-input-row {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.6);
      border-radius: 22px;
      padding: 6px 6px 6px 16px;
      transition: border-color 0.3s ease;
    }

    .chat-input-row:focus-within {
      border-color: var(--sand);
    }

    .chat-input-row textarea {
      flex: 1;
      border: none;
      outline: none;
      resize: none;
      background: transparent;
      font-size: 14px;
      font-weight: 300;
      line-height: 1.45;
      min-height: 24px;
      max-height: 100px;
      font-family: inherit;
      color: var(--ink);
      padding: 4px 0;
    }

    .chat-input-row textarea::placeholder {
      color: var(--ink-muted);
      font-size: 14px;
    }

    .send-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--ink);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.25s ease;
      flex-shrink: 0;
    }

    .send-btn:hover {
      background: var(--sand);
    }

    .send-btn svg {
      width: 14px;
      height: 14px;
      stroke: var(--white);
      stroke-width: 1.5;
      fill: none;
    }

    /* ===== About / Premium panel ===== */

    .about-panel {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--sand-bg);
      z-index: 10;
      display: flex;
      flex-direction: column;
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }

    .about-panel.open {
      transform: translateX(0);
    }

    .about-header {
      display: flex;
      align-items: center;
      padding: 12px 24px;
      border-bottom: 1px solid rgba(200, 184, 152, 0.15);
      flex-shrink: 0;
    }

    .about-back {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border-radius: 8px;
      transition: background 0.2s ease;
      margin-right: 8px;
    }

    .about-back:hover {
      background: rgba(200, 184, 152, 0.15);
    }

    .about-back svg {
      width: 18px;
      height: 18px;
      stroke: var(--ink-muted);
      stroke-width: 1.5;
      fill: none;
    }

    .about-title {
      font-size: 15px;
      font-weight: 400;
      color: var(--ink-soft);
    }

    .about-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px 24px;
      -webkit-overflow-scrolling: touch;
    }

    .about-section {
      margin-bottom: 24px;
    }

    .about-section-title {
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--ink-muted);
      margin: 0 0 10px;
    }

    .about-section p {
      font-size: 13px;
      line-height: 1.55;
      color: var(--ink-soft);
      font-weight: 300;
      margin: 0 0 8px;
    }

    .feature-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .feature-list li {
      font-size: 13px;
      font-weight: 300;
      color: var(--ink-soft);
      padding: 8px 0;
      border-bottom: 1px solid rgba(200, 184, 152, 0.12);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .feature-list li:last-child {
      border-bottom: none;
    }

    .feature-dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: var(--sand);
      flex-shrink: 0;
    }

    .feature-dot.premium {
      background: var(--ink-soft);
    }

    .about-card {
      background: rgba(255, 255, 255, 0.35);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      border-radius: 12px;
      padding: 14px 16px;
    }

    .about-link {
      display: block;
      font-size: 13px;
      font-weight: 400;
      color: var(--ink-soft);
      text-decoration: none;
      padding: 8px 0;
      border-bottom: 1px solid rgba(200, 184, 152, 0.12);
      cursor: pointer;
      transition: color 0.2s ease;
    }

    .about-link:last-child {
      border-bottom: none;
    }

    .about-link:hover {
      color: var(--ink);
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>

<div class="container">

  <!-- ONBOARDING -->
  <div id="onboarding">

    <div class="logo">
      <div class="logo-mark">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3L20 7.5V16.5L12 21L4 16.5V7.5L12 3Z" stroke="#fff" stroke-width="1.5" fill="none"/>
          <circle cx="12" cy="12" r="3" fill="#fff" opacity="0.9"/>
        </svg>
      </div>
      <div class="logo-text">
        <span class="logo-name">Shilpi</span>
        <span class="logo-subtitle">agent</span>
      </div>
    </div>
    <div class="intro-greeting">Hej,</div>
    <p class="intro-text">
      Jag är din personliga assistent och tar hand om sådant du inte ska behöva lägga tid på!
      <br><br>
      Du kan få påminnelser om det du vill, som att ringa mamma, köpa mjölk eller hämta paket. Jag håller också koll på vilka möten du har, hittar luckor och säger till om något möte krockar.
    </p>

    <div class="card">
      <div class="card-label">Ditt namn</div>
      <input id="userName" placeholder="Skriv ditt namn" />
    </div>

    <div class="card">
      <div class="card-label">Jag heter Shilpi</div>
      <p class="muted">Ge mig gärna ett annat namn om du vill</p>
      <input id="agentName" value="Shilpi" />
    </div>

    <div class="card">
      <div class="card-label">Välj min personlighet</div>
      <div class="choices">
        <div class="choice">Realistisk</div>
        <div class="choice">Humor</div>
        <div class="choice">Lugn</div>
        <div class="choice">Närvarande</div>
        <div class="choice">Varm</div>
        <div class="choice">Neutral</div>
      </div>
    </div>

    <div class="card">
      <div class="card-label">Koppla kalender</div>
      <div class="calendar-options">
        <a href="#" class="calendar-link" id="calendarLink">Microsoft</a>
        <a href="#" class="calendar-link" id="googleCalendarLink">Google</a>
      </div>
    </div>

    <div class="cta">
      <div id="startBtn">Kom igång</div>
    </div>

  </div>

  <!-- MAIN VIEW (Chat) -->
  <div id="mainView" class="hidden">

    <!-- Chat header -->
    <div class="chat-header">
      <div class="chat-header-left">
        <div class="logo-mark">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 3L20 7.5V16.5L12 21L4 16.5V7.5L12 3Z" stroke="#fff" stroke-width="1.5" fill="none"/>
            <circle cx="12" cy="12" r="3" fill="#fff" opacity="0.9"/>
          </svg>
        </div>
        <div>
          <div class="chat-header-name" id="chatHeaderName">Shilpi</div>
          <div class="chat-header-status">
            <div class="status-dot" id="statusDot"></div>
            <span id="authLabel">Kalender: ej ansluten</span>
          </div>
        </div>
      </div>
      <div class="menu-btn" id="menuBtn">
        <svg viewBox="0 0 24 24">
          <circle cx="12" cy="5" r="1.5" fill="currentColor" stroke="none"/>
          <circle cx="12" cy="12" r="1.5" fill="currentColor" stroke="none"/>
          <circle cx="12" cy="19" r="1.5" fill="currentColor" stroke="none"/>
        </svg>
      </div>
    </div>

    <!-- Messages -->
    <div class="chat-messages" id="chatMessages">
      <div class="chat-messages-spacer"></div>
      <div class="msg msg-agent" id="welcomeMsg"></div>
    </div>

    <!-- Input bar at bottom -->
    <div class="chat-input-bar">
      <div class="chat-input-row">
        <textarea
          id="messageInput"
          rows="1"
          placeholder="Skriv ett meddelande..."
        ></textarea>
        <div class="send-btn" id="sendBtn" aria-label="Skicka">
          <svg viewBox="0 0 24 24">
            <path d="M12 19V5" />
            <path d="M6 11l6-6 6 6" />
          </svg>
        </div>
      </div>
    </div>

    <!-- About / Premium panel -->
    <div class="about-panel" id="aboutPanel">
      <div class="about-header">
        <div class="about-back" id="aboutBack">
          <svg viewBox="0 0 24 24">
            <path d="M15 18l-6-6 6-6" />
          </svg>
        </div>
        <div class="about-title">Om Shilpi</div>
      </div>
      <div class="about-content">

        <div class="about-section">
          <div class="about-section-title">Vad kan Shilpi?</div>
          <ul class="feature-list">
            <li><span class="feature-dot"></span>Påminnelser — skriv vad du vill bli påmind om</li>
            <li><span class="feature-dot"></span>Kalenderkoll — se dagens möten och hitta luckor</li>
            <li><span class="feature-dot"></span>Möteskrock — varnar om något krockar</li>
            <li><span class="feature-dot premium"></span>AI-chatt — förstår dig oavsett hur du skriver</li>
            <li><span class="feature-dot premium"></span>Smart kalenderanalys</li>
          </ul>
        </div>

        <div class="about-section">
          <div class="about-section-title">Kalender</div>
          <div class="about-card">
            <a href="#" class="about-link" id="aboutCalendarMs">Koppla Microsoft-kalender</a>
            <a href="#" class="about-link" id="aboutCalendarGoogle">Koppla Google-kalender</a>
          </div>
        </div>

        <div class="about-section">
          <div class="about-section-title">Vanliga frågor</div>
          <div class="about-card">
            <div class="about-link" style="cursor:default; color: var(--ink-soft);">
              <strong style="font-weight:400;">Sparar Shilpi min data?</strong><br>
              <span style="color: var(--ink-muted); font-size: 12px;">Nej. Shilpi läser din kalender i realtid men sparar ingen mötesdata permanent.</span>
            </div>
            <div class="about-link" style="cursor:default; color: var(--ink-soft);">
              <strong style="font-weight:400;">Behöver IT godkänna?</strong><br>
              <span style="color: var(--ink-muted); font-size: 12px;">Nej. Du kopplar ditt eget konto — inget behöver godkännas av IT.</span>
            </div>
            <div class="about-link" style="cursor:default; color: var(--ink-soft); border-bottom: none;">
              <strong style="font-weight:400;">Var lagras uppgifterna?</strong><br>
              <span style="color: var(--ink-muted); font-size: 12px;">Inom EU. Dina uppgifter lämnar aldrig Europa.</span>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>

</div>

<script>
  const onboarding = document.getElementById("onboarding");
  const mainView = document.getElementById("mainView");
  const startBtn = document.getElementById("startBtn");
  const calendarLink = document.getElementById("calendarLink");
  const googleCalendarLink = document.getElementById("googleCalendarLink");

  const userNameInput = document.getElementById("userName");
  const agentNameInput = document.getElementById("agentName");

  const chatHeaderName = document.getElementById("chatHeaderName");
  const welcomeMsg = document.getElementById("welcomeMsg");

  const messageInput = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");
  const chatMessages = document.getElementById("chatMessages");
  const statusDot = document.getElementById("statusDot");
  const authLabel = document.getElementById("authLabel");

  const menuBtn = document.getElementById("menuBtn");
  const aboutPanel = document.getElementById("aboutPanel");
  const aboutBack = document.getElementById("aboutBack");
  const aboutCalendarMs = document.getElementById("aboutCalendarMs");
  const aboutCalendarGoogle = document.getElementById("aboutCalendarGoogle");

  let OWNER_NAME = "Du";
  let AGENT_NAME = "Shilpi";
  let PERSONALITY = "neutral";

  // --- Personality pills ---

  document.querySelectorAll(".choices .choice").forEach(pill => {
    pill.addEventListener("click", () => {
      document.querySelectorAll(".choices .choice").forEach(p => p.classList.remove("selected"));
      pill.classList.add("selected");
      PERSONALITY = pill.textContent.toLowerCase();
    });
  });

  // --- localStorage ---

  function saveSettings() {
    localStorage.setItem("shilpi_owner", OWNER_NAME);
    localStorage.setItem("shilpi_agent", AGENT_NAME);
    localStorage.setItem("shilpi_personality", PERSONALITY);
    localStorage.setItem("shilpi_onboarded", "1");
  }

  function restoreSession() {
    if (localStorage.getItem("shilpi_onboarded") === "1") {
      OWNER_NAME = localStorage.getItem("shilpi_owner") || "Du";
      AGENT_NAME = localStorage.getItem("shilpi_agent") || "Shilpi";
      PERSONALITY = localStorage.getItem("shilpi_personality") || "neutral";
      enterMainView();
      return true;
    }
    return false;
  }

  function enterMainView() {
    const greeting = OWNER_NAME !== "Du"
      ? "Hej " + OWNER_NAME + "! Vad kan jag hjälpa dig med?"
      : "Hej! Vad kan jag hjälpa dig med?";
    welcomeMsg.textContent = greeting;
    chatHeaderName.textContent = AGENT_NAME;
    onboarding.classList.add("hidden");
    mainView.classList.remove("hidden");
    scrollToBottom();
  }

  // --- Onboarding calendar links ---

  calendarLink.addEventListener("click", async (e) => {
    e.preventDefault();
    try {
      const res = await fetch("/auth/login");
      const data = await res.json();
      if (data.login_url) {
        document.cookie = "shilpi_user_id=" + data.user_id + ";path=/;max-age=2592000";
        window.location.href = data.login_url;
      }
    } catch (_) {}
  });

  googleCalendarLink.addEventListener("click", async (e) => {
    e.preventDefault();
    try {
      const res = await fetch("/auth/google/login");
      const data = await res.json();
      if (data.login_url) {
        document.cookie = "shilpi_user_id=" + data.user_id + ";path=/;max-age=2592000";
        window.location.href = data.login_url;
      }
    } catch (_) {}
  });

  startBtn.addEventListener("click", () => {
    const userName = userNameInput.value || "";
    const agentName = agentNameInput.value || "Shilpi";

    OWNER_NAME = userName || "Du";
    AGENT_NAME = agentName;

    saveSettings();
    enterMainView();
    requestNotificationPermission();
  });

  // --- About panel ---

  menuBtn.addEventListener("click", () => {
    aboutPanel.classList.add("open");
  });

  aboutBack.addEventListener("click", () => {
    aboutPanel.classList.remove("open");
  });

  aboutCalendarMs.addEventListener("click", async (e) => {
    e.preventDefault();
    try {
      const res = await fetch("/auth/login");
      const data = await res.json();
      if (data.login_url) {
        document.cookie = "shilpi_user_id=" + data.user_id + ";path=/;max-age=2592000";
        window.location.href = data.login_url;
      }
    } catch (_) {}
  });

  aboutCalendarGoogle.addEventListener("click", async (e) => {
    e.preventDefault();
    try {
      const res = await fetch("/auth/google/login");
      const data = await res.json();
      if (data.login_url) {
        document.cookie = "shilpi_user_id=" + data.user_id + ";path=/;max-age=2592000";
        window.location.href = data.login_url;
      }
    } catch (_) {}
  });

  // --- Chat ---

  function scrollToBottom() {
    requestAnimationFrame(() => {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    });
  }

  function addMessage(text, type) {
    const msg = document.createElement("div");
    msg.className = "msg " + type;
    msg.textContent = text;
    chatMessages.appendChild(msg);
    scrollToBottom();
  }

  function showTyping() {
    const msg = document.createElement("div");
    msg.className = "msg msg-typing";
    msg.id = "typingIndicator";
    msg.innerHTML = '<span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>';
    chatMessages.appendChild(msg);
    scrollToBottom();
  }

  function hideTyping() {
    const el = document.getElementById("typingIndicator");
    if (el) el.remove();
  }

  // Auto-resize textarea
  messageInput.addEventListener("input", () => {
    messageInput.style.height = "auto";
    messageInput.style.height = Math.min(messageInput.scrollHeight, 100) + "px";
  });

  async function sendMessage() {
    const text = messageInput.value.trim();
    if (!text) return;

    addMessage(text, "msg-user");
    messageInput.value = "";
    messageInput.style.height = "auto";

    showTyping();

    try {
      const res = await fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text, personality: PERSONALITY })
      });

      const data = await res.json();

      hideTyping();

      if (data && data.user_id) {
        document.cookie = "shilpi_user_id=" + data.user_id + ";path=/;max-age=2592000";
      }

      if (data && data.reply) {
        addMessage(data.reply, "msg-agent");
      }
    } catch (_) {
      hideTyping();
    }
  }

  // --- Notifications ---

  let notificationPermission = ("Notification" in window) ? Notification.permission : "denied";
  const originalTitle = document.title;
  let titleBlinkInterval = null;

  async function requestNotificationPermission() {
    if ("Notification" in window && Notification.permission === "default") {
      const result = await Notification.requestPermission();
      notificationPermission = result;
    }
  }

  function sendBrowserNotification(text) {
    if (notificationPermission === "granted") {
      const n = new Notification(AGENT_NAME, {
        body: text,
        icon: "/icon-192.png"
      });
      setTimeout(() => n.close(), 8000);
    }
  }

  function playNotificationSound() {
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.frequency.value = 680;
      osc.type = "sine";
      gain.gain.value = 0.15;
      osc.start();
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.4);
      osc.stop(ctx.currentTime + 0.4);
    } catch (_) {}
  }

  function blinkTitle(text) {
    if (titleBlinkInterval) return;
    let show = true;
    titleBlinkInterval = setInterval(() => {
      document.title = show ? "● " + text : originalTitle;
      show = !show;
    }, 1000);

    window.addEventListener("focus", stopBlinkTitle, { once: true });
  }

  function stopBlinkTitle() {
    if (titleBlinkInterval) {
      clearInterval(titleBlinkInterval);
      titleBlinkInterval = null;
      document.title = originalTitle;
    }
  }

  function notify(text) {
    sendBrowserNotification(text);
    playNotificationSound();
    if (document.hidden) {
      blinkTitle(AGENT_NAME);
    }
  }

  async function pollEvents() {
    try {
      const res = await fetch("/events");
      const events = await res.json();
      if (events.length) {
        const text = events.join("\n");
        addMessage(text, "msg-event");
        notify(text);
      }
    } catch (_) {}
  }

  // --- Auth ---

  async function checkAuthStatus() {
    try {
      const res = await fetch("/auth/status");
      const data = await res.json();

      if (data.connected) {
        statusDot.classList.add("connected");
        authLabel.textContent = "Kalender ansluten";
      } else {
        statusDot.classList.remove("connected");
        authLabel.textContent = "Kalender: ej ansluten";
      }
    } catch (_) {}
  }

  messageInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  sendBtn.addEventListener("click", sendMessage);

  // --- Init ---

  if (!restoreSession()) {
    // First visit — stay on onboarding
  }

  setInterval(pollEvents, 2000);
  setInterval(checkAuthStatus, 30000);
  checkAuthStatus();
</script>

</body>
</html>
