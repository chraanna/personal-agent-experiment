<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#f8f6f2" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="apple-touch-icon" href="/icon-192.png" />
  <title>Shilpi</title>

  <style>
    *, *::before, *::after {
      box-sizing: border-box;
    }

    :root {
      --sand: #c8b898;
      --sand-light: #e8dfd1;
      --sand-bg: #f8f6f2;
      --ink: #2a2a2a;
      --ink-soft: #6b6560;
      --ink-muted: #a09890;
      --white: #ffffff;
    }

    body {
      margin: 0;
      background: var(--sand-bg);
      color: var(--ink);
      font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont,
        "Helvetica Neue", Helvetica, Arial, sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      -webkit-font-smoothing: antialiased;
    }

    .container {
      width: 100%;
      max-width: 480px;
      padding: 0 24px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    /* ===== Onboarding ===== */

    #onboarding {
      border: none;
      padding: 0;
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 12px;
    }

    .frame {
      border: none;
      border-radius: 0;
      padding: 0;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 0 0 16px;
      opacity: 0;
      transform: translateY(8px);
      animation: fadeUp 0.5s ease forwards;
    }

    .logo-mark {
      width: 32px;
      height: 32px;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--sand) 0%, var(--sand-light) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(200, 184, 152, 0.3);
    }

    .logo-mark svg {
      width: 18px;
      height: 18px;
    }

    .logo-text {
      display: flex;
      flex-direction: column;
      line-height: 1;
    }

    .logo-name {
      font-size: 20px;
      font-weight: 400;
      letter-spacing: -0.02em;
      color: var(--ink-soft);
    }

    .logo-subtitle {
      font-size: 11px;
      font-weight: 300;
      letter-spacing: 0.32em;
      text-transform: uppercase;
      color: var(--ink-muted);
      margin-top: 2px;
    }

    .intro-greeting {
      font-size: 15px;
      font-weight: 400;
      color: var(--ink-soft);
      margin: 0 0 4px;
      padding: 0;
      opacity: 0;
      transform: translateY(8px);
      animation: fadeUp 0.5s ease forwards;
      animation-delay: 0.05s;
    }

    .intro-text {
      font-size: 14px;
      line-height: 1.6;
      color: var(--ink-soft);
      font-weight: 300;
      letter-spacing: 0.01em;
      margin: 0 0 6px;
      padding: 0;
      opacity: 0;
      transform: translateY(8px);
      animation: fadeUp 0.5s ease forwards;
      animation-delay: 0.1s;
    }

    .card {
      background: rgba(255, 255, 255, 0.35);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      border-radius: 14px;
      padding: 14px 16px;
      opacity: 0;
      transform: translateY(8px);
      animation: fadeUp 0.5s ease forwards;
    }

    .card:nth-of-type(1) { animation-delay: 0.2s; }
    .card:nth-of-type(2) { animation-delay: 0.35s; }
    .card:nth-of-type(3) { animation-delay: 0.5s; }
    .card:nth-of-type(4) { animation-delay: 0.65s; }

    @keyframes fadeUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card-label {
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--ink-muted);
      margin: 0 0 8px;
    }

    .muted {
      color: var(--ink-muted);
      font-size: 13px;
      margin: 0;
    }

    p {
      margin: 0 0 10px;
      font-size: 14px;
      line-height: 1.55;
      color: var(--ink);
      font-weight: 300;
    }

    input {
      width: 100%;
      font-size: 15px;
      font-weight: 300;
      padding: 4px 0;
      border: none;
      border-bottom: 1px solid var(--sand-light);
      outline: none;
      background: transparent;
      color: var(--ink);
      transition: border-color 0.3s ease;
      font-family: inherit;
    }

    input:focus {
      border-bottom-color: var(--sand);
    }

    input::placeholder {
      color: var(--ink-muted);
    }

    /* Personality pills */
    .choices {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .choice {
      padding: 6px 14px;
      font-size: 12px;
      font-weight: 400;
      letter-spacing: 0.02em;
      border: 1px solid rgba(255, 255, 255, 0.6);
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      color: var(--ink-soft);
      cursor: pointer;
      user-select: none;
      transition: all 0.25s ease;
    }

    .choice:hover {
      border-color: var(--sand);
      color: var(--ink);
      background: rgba(255, 255, 255, 0.5);
    }

    .choice.selected {
      background: var(--sand);
      border-color: var(--sand);
      color: var(--white);
    }

    /* Calendar links */
    .calendar-options {
      display: flex;
      gap: 16px;
    }

    .calendar-link {
      display: inline-block;
      font-size: 13px;
      font-weight: 400;
      color: var(--ink-soft);
      text-decoration: none;
      border-bottom: 1px solid var(--sand-light);
      transition: all 0.25s ease;
    }

    .calendar-link:hover {
      color: var(--ink);
      border-bottom-color: var(--sand);
    }

    /* CTA */
    .cta {
      margin-top: 4px;
      margin-bottom: 20px;
      display: flex;
      justify-content: center;
      opacity: 0;
      transform: translateY(8px);
      animation: fadeUp 0.5s ease forwards;
      animation-delay: 0.8s;
    }

    #startBtn {
      padding: 12px 44px;
      font-size: 14px;
      font-weight: 500;
      letter-spacing: 0.04em;
      background: var(--ink);
      color: var(--sand-bg);
      border: none;
      border-radius: 999px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    #startBtn:hover {
      background: var(--sand);
      color: var(--white);
    }

    /* ===== Auth bar ===== */

    .auth-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      font-size: 13px;
      color: var(--ink-muted);
      margin-bottom: 8px;
    }

    .auth-bar a {
      color: var(--ink-soft);
      text-decoration: none;
      font-weight: 400;
      cursor: pointer;
      transition: color 0.2s ease;
    }

    .auth-bar a:hover {
      color: var(--ink);
    }

    .auth-status {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--sand-light);
      transition: background 0.3s ease;
    }

    .status-dot.connected {
      background: #8fae83;
    }

    .next-meeting {
      font-size: 12px;
      color: var(--ink-muted);
    }

    /* ===== Main view ===== */

    textarea {
      width: 100%;
      border: none;
      outline: none;
      resize: none;
      background: transparent;
      font-size: 14px;
      font-weight: 300;
      line-height: 1.55;
      min-height: 72px;
      font-family: inherit;
      color: var(--ink);
    }

    textarea::placeholder {
      font-size: 12px;
      line-height: 1.5;
      color: var(--ink-muted);
      white-space: pre-line;
    }

    .input-frame {
      border: 1px solid var(--sand-light);
      border-radius: 12px;
      padding: 14px;
      margin-top: 20px;
      transition: border-color 0.3s ease;
    }

    .input-frame:focus-within {
      border-color: var(--sand);
    }

    .send-row {
      display: flex;
      justify-content: flex-end;
      margin-top: 8px;
    }

    .send-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--ink);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.25s ease;
    }

    .send-btn:hover {
      background: var(--sand);
    }

    .send-btn svg {
      width: 16px;
      height: 16px;
      stroke: var(--white);
      stroke-width: 1.5;
      fill: none;
    }

    /* ===== Logg ===== */

    #log {
      margin-top: 20px;
      white-space: pre-wrap;
      font-size: 14px;
      font-weight: 300;
      line-height: 1.55;
    }

    .entry {
      margin: 0;
    }

    .name {
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: var(--ink-muted);
      margin-bottom: 3px;
    }

    .log-owner {
      margin-bottom: 12px;
    }

    .log-agent {
      margin-top: 16px;
      margin-bottom: 12px;
      color: var(--ink-soft);
    }

    .log-events {
      margin-top: 16px;
      color: var(--ink-soft);
    }

    /* Typing indicator */
    .log-typing {
      margin-top: 16px;
      margin-bottom: 12px;
      color: var(--ink-muted);
    }

    .typing-dots span {
      animation: pulse 1.4s infinite both;
    }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes pulse {
      0%, 80%, 100% { opacity: 0.2; }
      40% { opacity: 1; }
    }

    .signature {
      margin-top: 16px;
      font-size: 13px;
      font-weight: 300;
      color: var(--ink-muted);
      letter-spacing: 0.02em;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>

<div class="container">

  <!-- ONBOARDING -->
  <div id="onboarding">

    <div class="logo">
      <div class="logo-mark">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3L20 7.5V16.5L12 21L4 16.5V7.5L12 3Z" stroke="#fff" stroke-width="1.5" fill="none"/>
          <circle cx="12" cy="12" r="3" fill="#fff" opacity="0.9"/>
        </svg>
      </div>
      <div class="logo-text">
        <span class="logo-name">Shilpi</span>
        <span class="logo-subtitle">agent</span>
      </div>
    </div>
    <div class="intro-greeting">Hej,</div>
    <p class="intro-text">
      Jag är din personliga assistent och tar hand om sådant du inte ska behöva lägga tid på!
      <br><br>
      Du kan få påminnelser om det du vill, som att ringa mamma, köpa mjölk eller hämta paket. Jag håller också koll på vilka möten du har, hittar luckor och säger till om något möte krockar.
    </p>

    <div class="card">
      <div class="card-label">Ditt namn</div>
      <input id="userName" placeholder="Skriv ditt namn" />
    </div>

    <div class="card">
      <div class="card-label">Jag heter Shilpi</div>
      <p class="muted">Ge mig gärna ett annat namn om du vill</p>
      <input id="agentName" value="Shilpi" />
    </div>

    <div class="card">
      <div class="card-label">Välj min personlighet</div>
      <div class="choices">
        <div class="choice">Realistisk</div>
        <div class="choice">Humor</div>
        <div class="choice">Lugn</div>
        <div class="choice">Närvarande</div>
        <div class="choice">Minimal</div>
        <div class="choice">Varm</div>
        <div class="choice">Neutral</div>
      </div>
    </div>

    <div class="card">
      <div class="card-label">Koppla kalender</div>
      <div class="calendar-options">
        <a href="#" class="calendar-link" id="calendarLink">Microsoft</a>
        <a href="#" class="calendar-link" id="googleCalendarLink">Google</a>
      </div>
    </div>

    <div class="cta">
      <div id="startBtn">Kom igång</div>
    </div>

  </div>

  <!-- MAIN VIEW -->
  <div id="mainView" class="hidden">

    <!-- Auth bar -->
    <div class="auth-bar">
      <div class="auth-status">
        <div class="status-dot" id="statusDot"></div>
        <span id="authLabel">Kalender: ej ansluten</span>
      </div>
      <div>
        <a id="loginLink" href="#">Logga in</a>
        <span class="next-meeting" id="nextMeeting"></span>
      </div>
    </div>

    <div class="frame">
      <p id="greeting"></p>

      <p>
        Vad vill du att jag tar ansvar för?<br>
        Skriv nedan så påminner jag när det är dags.
      </p>

      <div class="input-frame">
        <textarea
          id="messageInput"
          placeholder="påminna dig om att ringa mamma
hitta ledig tid när möten behöver planeras om
hålla koll på om något ändras i din kalender"
        ></textarea>

        <div class="send-row">
          <div class="send-btn" id="sendBtn" aria-label="Skicka">
            <svg viewBox="0 0 24 24">
              <path d="M12 19V5" />
              <path d="M6 11l6-6 6 6" />
            </svg>
          </div>
        </div>
      </div>

      <!-- Gemensam logg -->
      <div id="log"></div>

      <div class="signature" id="signature"></div>
    </div>
  </div>

</div>

<script>
  const onboarding = document.getElementById("onboarding");
  const mainView = document.getElementById("mainView");
  const startBtn = document.getElementById("startBtn");
  const calendarLink = document.getElementById("calendarLink");
  const googleCalendarLink = document.getElementById("googleCalendarLink");

  const userNameInput = document.getElementById("userName");
  const agentNameInput = document.getElementById("agentName");

  const greetingEl = document.getElementById("greeting");
  const signatureEl = document.getElementById("signature");

  const messageInput = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");
  const log = document.getElementById("log");
  const loginLink = document.getElementById("loginLink");
  const authLabel = document.getElementById("authLabel");
  const statusDot = document.getElementById("statusDot");
  const nextMeetingEl = document.getElementById("nextMeeting");

  let OWNER_NAME = "Du";
  let AGENT_NAME = "Shilpi";
  let PERSONALITY = "neutral";

  // --- Personality pills ---

  document.querySelectorAll(".choices .choice").forEach(pill => {
    pill.addEventListener("click", () => {
      document.querySelectorAll(".choices .choice").forEach(p => p.classList.remove("selected"));
      pill.classList.add("selected");
      PERSONALITY = pill.textContent.toLowerCase();
    });
  });

  // --- localStorage ---

  function saveSettings() {
    localStorage.setItem("shilpi_owner", OWNER_NAME);
    localStorage.setItem("shilpi_agent", AGENT_NAME);
    localStorage.setItem("shilpi_personality", PERSONALITY);
    localStorage.setItem("shilpi_onboarded", "1");
  }

  function restoreSession() {
    if (localStorage.getItem("shilpi_onboarded") === "1") {
      OWNER_NAME = localStorage.getItem("shilpi_owner") || "Du";
      AGENT_NAME = localStorage.getItem("shilpi_agent") || "Shilpi";
      PERSONALITY = localStorage.getItem("shilpi_personality") || "neutral";
      enterMainView();
      return true;
    }
    return false;
  }

  function enterMainView() {
    greetingEl.textContent = OWNER_NAME !== "Du" ? "Hej " + OWNER_NAME + "," : "Hej,";
    signatureEl.textContent = "/ " + AGENT_NAME;
    onboarding.classList.add("hidden");
    mainView.classList.remove("hidden");
  }

  // --- Onboarding ---

  calendarLink.addEventListener("click", async (e) => {
    e.preventDefault();
    try {
      const res = await fetch("/auth/login");
      const data = await res.json();
      if (data.login_url) {
        document.cookie = "shilpi_user_id=" + data.user_id + ";path=/;max-age=2592000";
        window.location.href = data.login_url;
      }
    } catch (_) {}
  });

  googleCalendarLink.addEventListener("click", async (e) => {
    e.preventDefault();
    try {
      const res = await fetch("/auth/google/login");
      const data = await res.json();
      if (data.login_url) {
        document.cookie = "shilpi_user_id=" + data.user_id + ";path=/;max-age=2592000";
        window.location.href = data.login_url;
      }
    } catch (_) {}
  });

  startBtn.addEventListener("click", () => {
    const userName = userNameInput.value || "";
    const agentName = agentNameInput.value || "Shilpi";

    OWNER_NAME = userName || "Du";
    AGENT_NAME = agentName;

    saveSettings();
    enterMainView();
    requestNotificationPermission();
  });

  // --- Chat ---

  function appendBlock(name, text, className) {
    const wrapper = document.createElement("div");
    wrapper.className = className;

    if (name) {
      const nameDiv = document.createElement("div");
      nameDiv.className = "name";
      nameDiv.textContent = name;
      wrapper.appendChild(nameDiv);
    }

    const textDiv = document.createElement("div");
    textDiv.className = "entry";
    textDiv.textContent = text;
    wrapper.appendChild(textDiv);

    log.appendChild(wrapper);
    log.scrollTop = log.scrollHeight;
  }

  function showTyping() {
    const wrapper = document.createElement("div");
    wrapper.className = "log-typing";
    wrapper.id = "typingIndicator";

    const nameDiv = document.createElement("div");
    nameDiv.className = "name";
    nameDiv.textContent = AGENT_NAME;
    wrapper.appendChild(nameDiv);

    const dots = document.createElement("div");
    dots.className = "typing-dots";
    dots.innerHTML = "<span>.</span><span>.</span><span>.</span>";
    wrapper.appendChild(dots);

    log.appendChild(wrapper);
    log.scrollTop = log.scrollHeight;
  }

  function hideTyping() {
    const el = document.getElementById("typingIndicator");
    if (el) el.remove();
  }

  async function sendMessage() {
    const text = messageInput.value.trim();
    if (!text) return;

    appendBlock(OWNER_NAME, text, "log-owner");
    messageInput.value = "";

    showTyping();

    try {
      const res = await fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text, personality: PERSONALITY })
      });

      const data = await res.json();

      hideTyping();

      if (data && data.user_id) {
        document.cookie = "shilpi_user_id=" + data.user_id + ";path=/;max-age=2592000";
      }

      if (data && data.reply) {
        appendBlock(AGENT_NAME, data.reply, "log-agent");
      }
    } catch (_) {
      hideTyping();
    }
  }

  // --- Notifications ---

  let notificationPermission = ("Notification" in window) ? Notification.permission : "denied";
  const originalTitle = document.title;
  let titleBlinkInterval = null;

  async function requestNotificationPermission() {
    if ("Notification" in window && Notification.permission === "default") {
      const result = await Notification.requestPermission();
      notificationPermission = result;
    }
  }

  function sendBrowserNotification(text) {
    if (notificationPermission === "granted") {
      const n = new Notification(AGENT_NAME, {
        body: text,
        icon: "/icon-192.png"
      });
      setTimeout(() => n.close(), 8000);
    }
  }

  function playNotificationSound() {
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.frequency.value = 680;
      osc.type = "sine";
      gain.gain.value = 0.15;
      osc.start();
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.4);
      osc.stop(ctx.currentTime + 0.4);
    } catch (_) {}
  }

  function blinkTitle(text) {
    if (titleBlinkInterval) return;
    let show = true;
    titleBlinkInterval = setInterval(() => {
      document.title = show ? "● " + text : originalTitle;
      show = !show;
    }, 1000);

    window.addEventListener("focus", stopBlinkTitle, { once: true });
  }

  function stopBlinkTitle() {
    if (titleBlinkInterval) {
      clearInterval(titleBlinkInterval);
      titleBlinkInterval = null;
      document.title = originalTitle;
    }
  }

  function notify(text) {
    sendBrowserNotification(text);
    playNotificationSound();
    if (document.hidden) {
      blinkTitle(AGENT_NAME);
    }
  }

  async function pollEvents() {
    try {
      const res = await fetch("/events");
      const events = await res.json();
      if (events.length) {
        const text = events.join("\n");
        appendBlock(null, text, "log-events");
        notify(text);
      }
    } catch (_) {}
  }

  // --- Auth ---

  loginLink.addEventListener("click", async (e) => {
    e.preventDefault();
    try {
      const res = await fetch("/auth/login");
      const data = await res.json();
      if (data.login_url) {
        document.cookie = "shilpi_user_id=" + data.user_id + ";path=/;max-age=2592000";
        window.location.href = data.login_url;
      }
    } catch (_) {}
  });

  async function checkAuthStatus() {
    try {
      const res = await fetch("/auth/status");
      const data = await res.json();

      if (data.connected) {
        statusDot.classList.add("connected");
        authLabel.textContent = "Kalender: ansluten";
        loginLink.style.display = "none";

        if (data.next_meeting) {
          nextMeetingEl.textContent = data.next_meeting;
        } else {
          nextMeetingEl.textContent = "";
        }
      } else {
        statusDot.classList.remove("connected");
        authLabel.textContent = "Kalender: ej ansluten";
        loginLink.style.display = "inline";
        nextMeetingEl.textContent = "";
      }
    } catch (_) {}
  }

  messageInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  sendBtn.addEventListener("click", sendMessage);

  // --- Init ---

  if (!restoreSession()) {
    // First visit — stay on onboarding
  }

  setInterval(pollEvents, 2000);
  setInterval(checkAuthStatus, 30000);
  checkAuthStatus();
</script>

</body>
</html>
